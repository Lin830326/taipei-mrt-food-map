<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¨ºæ–·å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        .progress {
            margin: 20px 0;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç³»çµ±å®Œæ•´è¨ºæ–·å·¥å…·</h1>
        <p class="subtitle">æª¢æŸ¥æ‰€æœ‰ç³»çµ±çµ„ä»¶å’Œ API é€£ç·šç‹€æ…‹</p>
        
        <div class="button-group">
            <button onclick="runFullDiagnostic()">ğŸš€ å®Œæ•´è¨ºæ–·</button>
            <button onclick="testGoogleMapsAPI()">ğŸ—ºï¸ æ¸¬è©¦ Google Maps</button>
            <button onclick="testConfigOnly()">âš™ï¸ åƒ…æ¸¬è©¦é…ç½®</button>
            <button onclick="window.location.href='index.html'" style="background: #28a745;">âœ… é–‹å•Ÿä¸»ç¨‹å¼</button>
        </div>
        
        <div class="test-section" style="background: #e7f3ff; border-left-color: #2196F3;">
            <div class="test-title">â„¹ï¸ é—œæ–¼ DOM å…ƒç´ æª¢æŸ¥</div>
            <div class="test-result info">
                <strong>æ³¨æ„:</strong> æ­¤è¨ºæ–·é é¢æœƒé¡¯ç¤º DOM å…ƒç´ ç¼ºå¤±,é€™æ˜¯æ­£å¸¸çš„!<br><br>
                
                åŸå› :<br>
                â€¢ é€™äº›å…ƒç´  (#map, #foodGrid, #searchBtn ç­‰) åªå­˜åœ¨æ–¼ <code>index.html</code><br>
                â€¢ è¨ºæ–·å·¥å…·æª¢æŸ¥çš„æ˜¯ç•¶å‰é é¢ (<code>test-system.html</code>)<br><br>
                
                è§£æ±ºæ–¹æ¡ˆ:<br>
                1. é»æ“Šä¸Šæ–¹ç¶ è‰²ã€Œâœ… é–‹å•Ÿä¸»ç¨‹å¼ã€æŒ‰éˆ•<br>
                2. æŒ‰ F12 é–‹å•Ÿé–‹ç™¼è€…å·¥å…·<br>
                3. æŸ¥çœ‹ Console ç¢ºèªæ²’æœ‰éŒ¯èª¤è¨Šæ¯<br>
                4. æŸ¥çœ‹åœ°åœ–æ˜¯å¦æ­£å¸¸é¡¯ç¤º
            </div>
        </div>
        
        <div id="progress" class="progress"></div>
        <div id="results"></div>
    </div>

    <!-- è¼‰å…¥é…ç½® -->
    <script src="config.js"></script>
    
    <!-- Google Maps API -->
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAIfX-FY50WPtoT5IxxpDllQIWv2-qEzc&libraries=places,geometry&callback=onGoogleMapsLoaded">
    </script>
    
    <script>
        let googleMapsLoaded = false;
        
        function onGoogleMapsLoaded() {
            googleMapsLoaded = true;
            console.log('âœ… Google Maps API å·²è¼‰å…¥');
            updateProgress('Google Maps API å·²è¼‰å…¥å®Œæˆ');
        }
        
        function updateProgress(message) {
            const progress = document.getElementById('progress');
            progress.textContent = message;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            updateProgress('');
        }
        
        function addResult(title, status, message, details) {
            const results = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'test-section';
            
            let statusClass = 'info';
            let icon = 'â„¹ï¸';
            
            if (status === 'pass') {
                statusClass = 'pass';
                icon = 'âœ…';
            } else if (status === 'fail') {
                statusClass = 'fail';
                icon = 'âŒ';
            } else if (status === 'warning') {
                statusClass = 'warning';
                icon = 'âš ï¸';
            }
            
            section.innerHTML = `
                <div class="test-title">${icon} ${title}</div>
                <div class="test-result ${statusClass}">
                    ${message}
                    ${details ? `<pre>${details}</pre>` : ''}
                </div>
            `;
            
            results.appendChild(section);
        }
        
        async function runFullDiagnostic() {
            clearResults();
            updateProgress('é–‹å§‹å®Œæ•´ç³»çµ±è¨ºæ–·...');
            
            // 1. æª¢æŸ¥ CONFIG
            updateProgress('1/5 æª¢æŸ¥é…ç½®æª”æ¡ˆ...');
            await sleep(100);
            checkConfig();
            
            // 2. æª¢æŸ¥ API Key
            updateProgress('2/5 æª¢æŸ¥ API Key...');
            await sleep(100);
            checkApiKey();
            
            // 3. æª¢æŸ¥ API Settings
            updateProgress('3/5 æª¢æŸ¥ API è¨­å®š...');
            await sleep(100);
            checkApiSettings();
            
            // 4. æª¢æŸ¥ SCORING_WEIGHTS
            updateProgress('4/5 æª¢æŸ¥è©•åˆ†æ¬Šé‡...');
            await sleep(100);
            checkScoringWeights();
            
            // 5. æª¢æŸ¥ Google Maps API
            updateProgress('5/5 æª¢æŸ¥ Google Maps API...');
            await sleep(100);
            testGoogleMapsAPI();
            
            updateProgress('âœ… è¨ºæ–·å®Œæˆ! å¦‚éœ€æ¸¬è©¦å®Œæ•´åŠŸèƒ½,è«‹é»æ“Šã€Œé–‹å•Ÿä¸»ç¨‹å¼ã€æŒ‰éˆ•');
        }
        
        async function testConfigOnly() {
            clearResults();
            updateProgress('æª¢æŸ¥é…ç½®æª”æ¡ˆ...');
            
            await sleep(100);
            checkConfig();
            await sleep(100);
            checkApiKey();
            await sleep(100);
            checkApiSettings();
            await sleep(100);
            checkScoringWeights();
            
            updateProgress('âœ… é…ç½®æª¢æŸ¥å®Œæˆ!');
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function checkConfig() {
            if (typeof CONFIG === 'undefined') {
                addResult('é…ç½®æª”æ¡ˆæª¢æŸ¥', 'fail', 
                    'âŒ CONFIG æœªå®šç¾©',
                    'config.js æª”æ¡ˆæœªæ­£ç¢ºè¼‰å…¥æˆ–æœ‰èªæ³•éŒ¯èª¤');
                return false;
            }
            
            addResult('é…ç½®æª”æ¡ˆæª¢æŸ¥', 'pass', 
                'âœ… CONFIG ç‰©ä»¶å·²æˆåŠŸè¼‰å…¥');
            return true;
        }
        
        function checkApiKey() {
            if (typeof CONFIG === 'undefined') return;
            
            if (!CONFIG.GOOGLE_API_KEY) {
                addResult('API Key æª¢æŸ¥', 'fail', 
                    'âŒ GOOGLE_API_KEY æœªè¨­å®š',
                    'è«‹åœ¨ config.js ä¸­è¨­å®šæ‚¨çš„ Google API Key');
                return false;
            }
            
            if (CONFIG.GOOGLE_API_KEY.includes('YOUR_API_KEY')) {
                addResult('API Key æª¢æŸ¥', 'warning', 
                    'âš ï¸ API Key å°šæœªæ›¿æ›ç‚ºçœŸå¯¦å€¼',
                    `ç•¶å‰å€¼: ${CONFIG.GOOGLE_API_KEY}`);
                return false;
            }
            
            addResult('API Key æª¢æŸ¥', 'pass', 
                'âœ… API Key å·²æ­£ç¢ºè¨­å®š',
                `Key: ${CONFIG.GOOGLE_API_KEY.substring(0, 25)}...${CONFIG.GOOGLE_API_KEY.substring(CONFIG.GOOGLE_API_KEY.length - 5)}\né•·åº¦: ${CONFIG.GOOGLE_API_KEY.length} å­—å…ƒ`);
            return true;
        }
        
        function checkApiSettings() {
            if (typeof CONFIG === 'undefined') return;
            
            if (!CONFIG.API_SETTINGS) {
                addResult('API è¨­å®šæª¢æŸ¥', 'fail', 
                    'âŒ API_SETTINGS ç‰©ä»¶æœªå®šç¾©',
                    'è«‹åœ¨ config.js ä¸­åŠ å…¥ API_SETTINGS ç‰©ä»¶');
                return false;
            }
            
            const checks = [];
            let allPass = true;
            
            // æª¢æŸ¥ TAIPEI_CENTER
            if (CONFIG.API_SETTINGS.TAIPEI_CENTER) {
                const center = CONFIG.API_SETTINGS.TAIPEI_CENTER;
                if (center.lat && center.lng) {
                    checks.push(`âœ… TAIPEI_CENTER: {lat: ${center.lat}, lng: ${center.lng}}`);
                } else {
                    checks.push(`âŒ TAIPEI_CENTER ç¼ºå°‘ lat æˆ– lng`);
                    allPass = false;
                }
            } else {
                checks.push(`âŒ TAIPEI_CENTER æœªå®šç¾©`);
                allPass = false;
            }
            
            // æª¢æŸ¥å…¶ä»–è¨­å®š
            checks.push(`${CONFIG.API_SETTINGS.MAX_RESULTS ? 'âœ…' : 'âŒ'} MAX_RESULTS: ${CONFIG.API_SETTINGS.MAX_RESULTS || 'undefined'}`);
            checks.push(`${CONFIG.API_SETTINGS.DEFAULT_SEARCH_RADIUS ? 'âœ…' : 'âŒ'} DEFAULT_SEARCH_RADIUS: ${CONFIG.API_SETTINGS.DEFAULT_SEARCH_RADIUS || 'undefined'}`);
            checks.push(`${CONFIG.API_SETTINGS.WALKING_SPEED ? 'âœ…' : 'âš ï¸'} WALKING_SPEED: ${CONFIG.API_SETTINGS.WALKING_SPEED || 'undefined'}`);
            
            if (allPass) {
                addResult('API è¨­å®šæª¢æŸ¥', 'pass', 
                    'âœ… API_SETTINGS æ‰€æœ‰å¿…è¦å±¬æ€§éƒ½å·²å®šç¾©',
                    checks.join('\n'));
            } else {
                addResult('API è¨­å®šæª¢æŸ¥', 'warning', 
                    'âš ï¸ API_SETTINGS æœ‰éƒ¨åˆ†å±¬æ€§ç¼ºå¤±',
                    checks.join('\n'));
            }
            
            return allPass;
        }
        
        function checkScoringWeights() {
            if (typeof CONFIG === 'undefined') return;
            
            if (!CONFIG.SCORING_WEIGHTS) {
                addResult('è©•åˆ†æ¬Šé‡æª¢æŸ¥', 'fail', 
                    'âŒ SCORING_WEIGHTS æœªå®šç¾©',
                    'è«‹åœ¨ config.js ä¸­åŠ å…¥ SCORING_WEIGHTS ç‰©ä»¶');
                return false;
            }
            
            const weights = CONFIG.SCORING_WEIGHTS;
            const checks = [];
            
            // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨å°å¯«å±¬æ€§åç¨±
            const hasLowercase = 'rating' in weights;
            const hasUppercase = 'RATING' in weights;
            
            if (hasUppercase && !hasLowercase) {
                checks.push(`âš ï¸ ä½¿ç”¨å¤§å¯«å±¬æ€§åç¨± (ä¸å»ºè­°)`);
                checks.push(`RATING: ${weights.RATING}`);
                checks.push(`DISTANCE: ${weights.DISTANCE}`);
                checks.push(`REVIEWS: ${weights.REVIEWS}`);
                checks.push(`PRICE: ${weights.PRICE}`);
                
                addResult('è©•åˆ†æ¬Šé‡æª¢æŸ¥', 'warning', 
                    'âš ï¸ å±¬æ€§åç¨±æ‡‰æ”¹ç‚ºå°å¯« (rating, distance, reviews, price)',
                    checks.join('\n') + '\n\nå»ºè­°ä¿®æ”¹ç‚ºå°å¯«,èˆ‡ app.js ä¸­çš„ç¨‹å¼ç¢¼ä¸€è‡´');
                return false;
            }
            
            if (hasLowercase) {
                checks.push(`âœ… rating: ${weights.rating}`);
                checks.push(`âœ… distance: ${weights.distance}`);
                checks.push(`âœ… reviews: ${weights.reviews}`);
                checks.push(`âœ… price: ${weights.price}`);
                
                const total = weights.rating + weights.distance + weights.reviews + weights.price;
                checks.push(`\nç¸½å’Œ: ${total.toFixed(2)} ${total === 1.0 ? 'âœ…' : 'âš ï¸ (å»ºè­°ç‚º 1.0)'}`);
                
                addResult('è©•åˆ†æ¬Šé‡æª¢æŸ¥', 'pass', 
                    'âœ… SCORING_WEIGHTS å·²æ­£ç¢ºå®šç¾© (ä½¿ç”¨å°å¯«å±¬æ€§åç¨±)',
                    checks.join('\n'));
                return true;
            }
            
            addResult('è©•åˆ†æ¬Šé‡æª¢æŸ¥', 'fail', 
                'âŒ SCORING_WEIGHTS ç¼ºå°‘å¿…è¦å±¬æ€§',
                'éœ€è¦: rating, distance, reviews, price');
            return false;
        }
        
        function testGoogleMapsAPI() {
            if (!googleMapsLoaded && typeof google === 'undefined') {
                addResult('Google Maps API', 'warning', 
                    'â³ Google Maps API æ­£åœ¨è¼‰å…¥ä¸­...',
                    'è«‹ç¨å€™å¹¾ç§’é˜å¾Œå†æ¬¡æª¢æŸ¥\n\nå¦‚æœä¸€ç›´é¡¯ç¤ºæ­¤è¨Šæ¯,å¯èƒ½çš„åŸå› :\n1. ç¶²è·¯é€£ç·šå•é¡Œ\n2. API Key ç„¡æ•ˆ\n3. API é…é¡å·²ç”¨ç›¡\n4. ç¶²åŸŸé™åˆ¶è¨­å®šéŒ¯èª¤');
                
                // 5ç§’å¾Œå†æª¢æŸ¥ä¸€æ¬¡
                setTimeout(() => {
                    if (typeof google !== 'undefined') {
                        location.reload();
                    }
                }, 5000);
                return false;
            }
            
            if (typeof google === 'undefined') {
                addResult('Google Maps API', 'fail', 
                    'âŒ Google Maps API è¼‰å…¥å¤±æ•—',
                    'è«‹æª¢æŸ¥:\n1. index.html æ˜¯å¦åŒ…å«æ­£ç¢ºçš„ script æ¨™ç±¤\n2. API Key æ˜¯å¦æœ‰æ•ˆ\n3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\n4. ç€è¦½å™¨ Console æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯');
                return false;
            }
            
            if (!google.maps) {
                addResult('Google Maps API', 'fail', 
                    'âŒ google.maps ç‰©ä»¶ä¸å­˜åœ¨',
                    'å¯èƒ½åŸå› :\n1. API è¼‰å…¥æœªå®Œæˆ\n2. API Key ç„¡æ•ˆæˆ–å—é™\n3. é…é¡å·²ç”¨ç›¡');
                return false;
            }
            
            const checks = [];
            checks.push(`âœ… google ç‰©ä»¶å·²å®šç¾©`);
            checks.push(`âœ… google.maps ç‰©ä»¶å·²å®šç¾©`);
            
            // æª¢æŸ¥é‡è¦çš„ API
            const apis = [
                { name: 'Map', obj: google.maps.Map },
                { name: 'places.PlacesService', obj: google.maps.places?.PlacesService },
                { name: 'Geocoder', obj: google.maps.Geocoder },
                { name: 'geometry', obj: google.maps.geometry }
            ];
            
            apis.forEach(api => {
                if (api.obj) {
                    checks.push(`âœ… google.maps.${api.name} å¯ç”¨`);
                } else {
                    checks.push(`âŒ google.maps.${api.name} ä¸å¯ç”¨`);
                }
            });
            
            addResult('Google Maps API', 'pass', 
                'âœ… Google Maps API å·²æˆåŠŸè¼‰å…¥ä¸¦å¯ç”¨',
                checks.join('\n'));
            
            // é€²è¡Œå¯¦éš›åœ°åœ–åˆå§‹åŒ–æ¸¬è©¦
            testMapInitialization();
            
            return true;
        }
        
        function testMapInitialization() {
            try {
                const testDiv = document.createElement('div');
                testDiv.style.width = '100px';
                testDiv.style.height = '100px';
                testDiv.style.display = 'none';
                document.body.appendChild(testDiv);
                
                const testMap = new google.maps.Map(testDiv, {
                    center: { lat: 25.0330, lng: 121.5654 },
                    zoom: 13
                });
                
                document.body.removeChild(testDiv);
                
                addResult('åœ°åœ–åˆå§‹åŒ–æ¸¬è©¦', 'pass', 
                    'âœ… å¯ä»¥æˆåŠŸå»ºç«‹ Google Map å¯¦ä¾‹',
                    'æ¸¬è©¦å»ºç«‹äº†ä¸€å€‹è‡¨æ™‚åœ°åœ–ä¸¦æˆåŠŸåˆå§‹åŒ–');
                
            } catch (error) {
                addResult('åœ°åœ–åˆå§‹åŒ–æ¸¬è©¦', 'fail', 
                    'âŒ ç„¡æ³•å»ºç«‹åœ°åœ–å¯¦ä¾‹',
                    `éŒ¯èª¤è¨Šæ¯: ${error.message}\n\nå®Œæ•´éŒ¯èª¤:\n${error.stack}`);
            }
        }
        
        // é é¢è¼‰å…¥å¾Œé¡¯ç¤ºæç¤º
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('ç³»çµ±å°±ç·’', 'info', 
                    'â„¹ï¸ è¨ºæ–·å·¥å…·å·²æº–å‚™å°±ç·’',
                    'é»æ“Šä¸Šæ–¹ã€Œå®Œæ•´è¨ºæ–·ã€æŒ‰éˆ•é–‹å§‹æª¢æŸ¥æ‰€æœ‰ç³»çµ±çµ„ä»¶');
            }, 1000);
        });
    </script>
</body>
</html>
