<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¨ºæ–·å·¥å…· - é€†å‘å·¥ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #808080;
            margin-bottom: 30px;
        }

        .test-section {
            background: #252526;
            border-left: 4px solid #007acc;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .test-section h2 {
            color: #569cd6;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .test-item {
            padding: 12px;
            margin: 10px 0;
            background: #1e1e1e;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .test-name {
            flex: 1;
        }

        .test-status {
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }

        .status-pending {
            background: #3a3a3a;
            color: #808080;
        }

        .status-running {
            background: #1a4d7a;
            color: #4fc3f7;
            animation: pulse 1.5s infinite;
        }

        .status-pass {
            background: #1a4d2e;
            color: #4caf50;
        }

        .status-fail {
            background: #7a1a1a;
            color: #f44336;
        }

        .status-warning {
            background: #7a5a1a;
            color: #ff9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .error-details {
            background: #3a1a1a;
            border-left: 3px solid #f44336;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #ff9999;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .success-details {
            background: #1a3a1a;
            border-left: 3px solid #4caf50;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #99ff99;
        }

        .info-box {
            background: #1a3a5a;
            border-left: 3px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #99ccff;
        }

        .code-block {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto;
            border: 1px solid #3a3a3a;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: all 0.3s;
        }

        button:hover {
            background: #005a9e;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #3a3a3a;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #3a3a3a;
            border-radius: 2px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007acc, #4ec9b0);
            width: 0%;
            transition: width 0.3s;
        }

        .json-viewer {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .key {
            color: #9cdcfe;
        }

        .string {
            color: #ce9178;
        }

        .number {
            color: #b5cea8;
        }

        .boolean {
            color: #569cd6;
        }

        .controls {
            position: sticky;
            top: 0;
            background: #1e1e1e;
            padding: 15px 0;
            z-index: 100;
            border-bottom: 2px solid #007acc;
            margin-bottom: 20px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: #252526;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
        }

        .summary-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            color: #808080;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h1>ğŸ” é€†å‘å·¥ç¨‹è¨ºæ–·å·¥å…·</h1>
            <p class="subtitle">è‡ªå‹•åŒ–ç³»çµ±æ¸¬è©¦èˆ‡å•é¡Œåµæ¸¬</p>
            <button onclick="startDiagnostic()" id="startBtn">é–‹å§‹è¨ºæ–·</button>
            <button onclick="testRealSearch()" id="testSearchBtn">æ¸¬è©¦çœŸå¯¦æœå°‹</button>
            <button onclick="exportReport()" id="exportBtn" disabled>åŒ¯å‡ºå ±å‘Š</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div class="summary" id="summary" style="display: none;">
            <div class="summary-card">
                <div class="summary-label">ç¸½æ¸¬è©¦æ•¸</div>
                <div class="summary-value" id="totalTests">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" style="color: #4caf50;" id="passedTests">0</div>
                <div class="summary-label">é€šé</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" style="color: #f44336;" id="failedTests">0</div>
                <div class="summary-label">å¤±æ•—</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" style="color: #ff9800;" id="warningTests">0</div>
                <div class="summary-label">è­¦å‘Š</div>
            </div>
        </div>

        <!-- Test Sections -->
        <div class="test-section">
            <h2>ğŸ“¦ 1. æª”æ¡ˆè¼‰å…¥æª¢æŸ¥</h2>
            <div id="fileTests"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”‘ 2. API é…ç½®æª¢æŸ¥</h2>
            <div id="apiTests"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ—ºï¸ 3. Google Maps API æª¢æŸ¥</h2>
            <div id="mapsTests"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ 4. DOM å…ƒç´ æª¢æŸ¥</h2>
            <div id="domTests"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ 5. åŠŸèƒ½æ¸¬è©¦</h2>
            <div id="functionTests"></div>
        </div>

        <div class="test-section">
            <h2>ğŸŒ 6. ç¶²è·¯èˆ‡ API å‘¼å«æ¸¬è©¦</h2>
            <div id="networkTests"></div>
        </div>
    </div>

    <script>
        const diagnosticResults = {
            tests: [],
            startTime: null,
            endTime: null,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        function createTestItem(name, containerId) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'test-item';
            item.id = `test-${Date.now()}-${Math.random()}`;
            item.innerHTML = `
                <span class="test-name">${name}</span>
                <span class="test-status status-pending">ç­‰å¾…ä¸­</span>
            `;
            container.appendChild(item);
            return item;
        }

        function updateTestStatus(item, status, details = null) {
            const statusEl = item.querySelector('.test-status');
            statusEl.className = `test-status status-${status}`;
            
            const statusText = {
                'running': 'åŸ·è¡Œä¸­...',
                'pass': 'âœ“ é€šé',
                'fail': 'âœ— å¤±æ•—',
                'warning': 'âš  è­¦å‘Š'
            };
            
            statusEl.textContent = statusText[status] || status;

            if (details) {
                const detailsEl = document.createElement('div');
                detailsEl.className = status === 'fail' ? 'error-details' : 'success-details';
                detailsEl.textContent = details;
                item.appendChild(detailsEl);
            }

            // æ›´æ–°çµ±è¨ˆ
            if (status === 'pass') diagnosticResults.passed++;
            if (status === 'fail') diagnosticResults.failed++;
            if (status === 'warning') diagnosticResults.warnings++;
        }

        async function startDiagnostic() {
            console.log('ğŸš€ é–‹å§‹é€†å‘å·¥ç¨‹è¨ºæ–·...');
            diagnosticResults.startTime = new Date();
            diagnosticResults.tests = [];
            diagnosticResults.passed = 0;
            diagnosticResults.failed = 0;
            diagnosticResults.warnings = 0;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('summary').style.display = 'grid';

            // 1. æª”æ¡ˆè¼‰å…¥æª¢æŸ¥
            await testFileLoading();

            // 2. API é…ç½®æª¢æŸ¥
            await testAPIConfig();

            // 3. Google Maps API æª¢æŸ¥
            await testGoogleMapsAPI();

            // 4. DOM å…ƒç´ æª¢æŸ¥
            await testDOMElements();

            // 5. åŠŸèƒ½æ¸¬è©¦
            await testFunctions();

            // 6. ç¶²è·¯æ¸¬è©¦
            await testNetwork();

            diagnosticResults.endTime = new Date();
            updateSummary();
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('startBtn').disabled = false;

            console.log('âœ… è¨ºæ–·å®Œæˆ!', diagnosticResults);
        }

        async function testFileLoading() {
            updateProgress(10);

            // Test 1.1: config.js
            const test1 = createTestItem('æª¢æŸ¥ config.js æ˜¯å¦è¼‰å…¥', 'fileTests');
            updateTestStatus(test1, 'running');
            await sleep(300);
            
            if (typeof CONFIG !== 'undefined') {
                updateTestStatus(test1, 'pass', `CONFIG ç‰©ä»¶å·²è¼‰å…¥ï¼ŒåŒ…å« ${Object.keys(CONFIG).length} å€‹å±¬æ€§`);
            } else {
                updateTestStatus(test1, 'fail', 'CONFIG ç‰©ä»¶æœªå®šç¾©ï¼Œè«‹ç¢ºèª config.js å·²æ­£ç¢ºè¼‰å…¥');
            }

            // Test 1.2: app.js
            const test2 = createTestItem('æª¢æŸ¥ app.js æ˜¯å¦è¼‰å…¥', 'fileTests');
            updateTestStatus(test2, 'running');
            await sleep(300);
            
            if (typeof initApp !== 'undefined') {
                updateTestStatus(test2, 'pass', 'ä¸»æ‡‰ç”¨ç¨‹å¼å·²è¼‰å…¥');
            } else {
                updateTestStatus(test2, 'fail', 'app.js æœªæ­£ç¢ºè¼‰å…¥');
            }
        }

        async function testAPIConfig() {
            updateProgress(25);

            // Test 2.1: API Key å­˜åœ¨
            const test1 = createTestItem('æª¢æŸ¥ API Key æ˜¯å¦è¨­å®š', 'apiTests');
            updateTestStatus(test1, 'running');
            await sleep(300);
            
            if (CONFIG && CONFIG.GOOGLE_API_KEY && CONFIG.GOOGLE_API_KEY !== 'YOUR_API_KEY_HERE') {
                updateTestStatus(test1, 'pass', `API Key: ${CONFIG.GOOGLE_API_KEY.substring(0, 20)}...`);
            } else {
                updateTestStatus(test1, 'fail', 'API Key æœªè¨­å®šæˆ–ä»ç‚ºé è¨­å€¼');
            }

            // Test 2.2: API é…ç½®å®Œæ•´æ€§
            const test2 = createTestItem('æª¢æŸ¥ API é…ç½®å®Œæ•´æ€§', 'apiTests');
            updateTestStatus(test2, 'running');
            await sleep(300);
            
            const requiredKeys = ['GOOGLE_API_KEY', 'GOOGLE_LIBRARIES', 'DEFAULT_SEARCH_RADIUS'];
            const missingKeys = requiredKeys.filter(key => !CONFIG || !CONFIG[key]);
            
            if (missingKeys.length === 0) {
                updateTestStatus(test2, 'pass', 'æ‰€æœ‰å¿…è¦é…ç½®é …ç›®å®Œæ•´');
            } else {
                updateTestStatus(test2, 'fail', `ç¼ºå°‘é…ç½®: ${missingKeys.join(', ')}`);
            }
        }

        async function testGoogleMapsAPI() {
            updateProgress(40);

            // Test 3.1: Google API è…³æœ¬è¼‰å…¥
            const test1 = createTestItem('æª¢æŸ¥ Google Maps API è…³æœ¬', 'mapsTests');
            updateTestStatus(test1, 'running');
            await sleep(500);
            
            const googleScript = document.querySelector('script[src*="maps.googleapis.com"]');
            if (googleScript) {
                updateTestStatus(test1, 'pass', `è…³æœ¬ URL: ${googleScript.src.substring(0, 60)}...`);
            } else {
                updateTestStatus(test1, 'fail', 'Google Maps API è…³æœ¬æœªè¼‰å…¥');
            }

            // Test 3.2: Google ç‰©ä»¶å¯ç”¨æ€§
            const test2 = createTestItem('æª¢æŸ¥ Google ç‰©ä»¶æ˜¯å¦å¯ç”¨', 'mapsTests');
            updateTestStatus(test2, 'running');
            await sleep(1000);
            
            if (typeof google !== 'undefined' && google.maps) {
                updateTestStatus(test2, 'pass', `Google Maps API ç‰ˆæœ¬: ${google.maps.version || 'æœªçŸ¥'}`);
            } else {
                updateTestStatus(test2, 'fail', 'Google ç‰©ä»¶æœªå®šç¾©ï¼ŒAPI å¯èƒ½è¼‰å…¥å¤±æ•—');
            }

            // Test 3.3: Places Service å¯ç”¨æ€§
            const test3 = createTestItem('æª¢æŸ¥ Places Service', 'mapsTests');
            updateTestStatus(test3, 'running');
            await sleep(500);
            
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                updateTestStatus(test3, 'pass', 'Places API å¯ç”¨');
            } else {
                updateTestStatus(test3, 'fail', 'Places API æœªè¼‰å…¥');
            }

            // Test 3.4: Geocoding Service
            const test4 = createTestItem('æª¢æŸ¥ Geocoding Service', 'mapsTests');
            updateTestStatus(test4, 'running');
            await sleep(500);
            
            if (typeof google !== 'undefined' && google.maps && google.maps.Geocoder) {
                updateTestStatus(test4, 'pass', 'Geocoding API å¯ç”¨');
            } else {
                updateTestStatus(test4, 'fail', 'Geocoding API æœªè¼‰å…¥');
            }
        }

        async function testDOMElements() {
            updateProgress(60);

            const requiredElements = [
                { id: 'currentStation', name: 'ç•¶å‰ç«™é»é¡¯ç¤º' },
                { id: 'radiusSelect', name: 'æœå°‹åŠå¾‘é¸æ“‡å™¨' },
                { id: 'priceRange', name: 'åƒ¹æ ¼ç¯„åœæ»‘æ¡¿' },
                { id: 'sortSelect', name: 'æ’åºé¸æ“‡å™¨' },
                { id: 'openNowCheck', name: 'ç‡Ÿæ¥­ä¸­å‹¾é¸æ¡†' },
                { id: 'searchBtn', name: 'æœå°‹æŒ‰éˆ•' },
                { id: 'foodGrid', name: 'ç¾é£Ÿåˆ—è¡¨å®¹å™¨' },
                { id: 'map', name: 'åœ°åœ–å®¹å™¨' },
                { id: 'loadingIndicator', name: 'è¼‰å…¥æŒ‡ç¤ºå™¨' }
            ];

            for (const elem of requiredElements) {
                const test = createTestItem(`æª¢æŸ¥å…ƒç´ : ${elem.name}`, 'domTests');
                updateTestStatus(test, 'running');
                await sleep(200);
                
                const element = document.getElementById(elem.id);
                if (element) {
                    updateTestStatus(test, 'pass', `ID: #${elem.id}`);
                } else {
                    updateTestStatus(test, 'fail', `æ‰¾ä¸åˆ°å…ƒç´  #${elem.id}`);
                }
            }
        }

        async function testFunctions() {
            updateProgress(75);

            // Test 5.1: æ ¸å¿ƒå‡½æ•¸å­˜åœ¨
            const functions = [
                'selectStation',
                'performSmartSearch',
                'toggleLine',
                'showApiSetup',
                'initMap'
            ];

            for (const funcName of functions) {
                const test = createTestItem(`æª¢æŸ¥å‡½æ•¸: ${funcName}()`, 'functionTests');
                updateTestStatus(test, 'running');
                await sleep(200);
                
                if (typeof window[funcName] === 'function') {
                    updateTestStatus(test, 'pass', 'å‡½æ•¸å·²å®šç¾©');
                } else {
                    updateTestStatus(test, 'fail', `å‡½æ•¸ ${funcName} æœªå®šç¾©`);
                }
            }
        }

        async function testNetwork() {
            updateProgress(90);

            // Test 6.1: ç¶²è·¯é€£ç·š
            const test1 = createTestItem('æª¢æŸ¥ç¶²è·¯é€£ç·š', 'networkTests');
            updateTestStatus(test1, 'running');
            await sleep(300);
            
            if (navigator.onLine) {
                updateTestStatus(test1, 'pass', 'ç¶²è·¯å·²é€£ç·š');
            } else {
                updateTestStatus(test1, 'fail', 'ç„¡ç¶²è·¯é€£ç·š');
            }

            // Test 6.2: Google API å¯é”æ€§
            const test2 = createTestItem('æ¸¬è©¦ Google API å¯é”æ€§', 'networkTests');
            updateTestStatus(test2, 'running');
            
            try {
                const response = await fetch('https://maps.googleapis.com/maps/api/js?key=test', { method: 'HEAD' });
                updateTestStatus(test2, 'pass', `ç‹€æ…‹ç¢¼: ${response.status}`);
            } catch (error) {
                updateTestStatus(test2, 'warning', `ç„¡æ³•é€£æ¥: ${error.message}`);
            }

            updateProgress(100);
        }

        async function testRealSearch() {
            const btn = document.getElementById('testSearchBtn');
            btn.disabled = true;
            btn.textContent = 'æ¸¬è©¦ä¸­...';

            const container = document.getElementById('networkTests');
            const testDiv = document.createElement('div');
            testDiv.className = 'info-box';
            testDiv.innerHTML = '<h3>ğŸ” çœŸå¯¦æœå°‹æ¸¬è©¦</h3><div id="searchTestResults">åˆå§‹åŒ–ä¸­...</div>';
            container.appendChild(testDiv);

            const resultsDiv = document.getElementById('searchTestResults');

            try {
                resultsDiv.innerHTML = 'æ­¥é©Ÿ 1: æª¢æŸ¥ Google Maps API...';
                await sleep(500);

                if (typeof google === 'undefined' || !google.maps) {
                    throw new Error('Google Maps API æœªè¼‰å…¥');
                }

                resultsDiv.innerHTML += '<br>âœ“ Google Maps API å·²è¼‰å…¥';
                await sleep(500);

                resultsDiv.innerHTML += '<br><br>æ­¥é©Ÿ 2: åˆå§‹åŒ– Geocoder...';
                const geocoder = new google.maps.Geocoder();
                resultsDiv.innerHTML += '<br>âœ“ Geocoder å·²åˆå§‹åŒ–';
                await sleep(500);

                resultsDiv.innerHTML += '<br><br>æ­¥é©Ÿ 3: æœå°‹å°åŒ—è»Šç«™åº§æ¨™...';
                
                geocoder.geocode({ address: 'å°åŒ—å°åŒ—è»Šç«™æ·é‹ç«™' }, async (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resultsDiv.innerHTML += `<br>âœ“ æ‰¾åˆ°åº§æ¨™: ${location.lat()}, ${location.lng()}`;
                        resultsDiv.innerHTML += `<br>âœ“ åœ°å€: ${results[0].formatted_address}`;

                        resultsDiv.innerHTML += '<br><br>æ­¥é©Ÿ 4: åˆå§‹åŒ–åœ°åœ–...';
                        const testMap = new google.maps.Map(document.getElementById('map'), {
                            center: location,
                            zoom: 15
                        });
                        resultsDiv.innerHTML += '<br>âœ“ åœ°åœ–å·²åˆå§‹åŒ–';
                        await sleep(500);

                        resultsDiv.innerHTML += '<br><br>æ­¥é©Ÿ 5: æœå°‹é™„è¿‘é¤å»³...';
                        const service = new google.maps.places.PlacesService(testMap);
                        
                        const request = {
                            location: location,
                            radius: 800,
                            type: 'restaurant'
                        };

                        service.nearbySearch(request, (results, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK) {
                                resultsDiv.innerHTML += `<br>âœ“ æœå°‹æˆåŠŸ! æ‰¾åˆ° ${results.length} å€‹çµæœ`;
                                resultsDiv.innerHTML += '<br><br><strong>å‰ 5 ç­†çµæœ:</strong>';
                                
                                results.slice(0, 5).forEach((place, i) => {
                                    resultsDiv.innerHTML += `<br>${i + 1}. ${place.name} (è©•åˆ†: ${place.rating || 'N/A'})`;
                                });

                                resultsDiv.innerHTML += '<br><br><div style="color: #4caf50; font-size: 1.2em;">âœ… æ‰€æœ‰æ¸¬è©¦é€šé! API åŠŸèƒ½æ­£å¸¸</div>';
                            } else {
                                throw new Error(`Places API éŒ¯èª¤: ${status}`);
                            }

                            btn.disabled = false;
                            btn.textContent = 'æ¸¬è©¦çœŸå¯¦æœå°‹';
                        });

                    } else {
                        throw new Error(`Geocoding å¤±æ•—: ${status}`);
                    }
                });

            } catch (error) {
                resultsDiv.innerHTML += `<br><br><div style="color: #f44336;">âŒ éŒ¯èª¤: ${error.message}</div>`;
                console.error('æ¸¬è©¦éŒ¯èª¤:', error);
                btn.disabled = false;
                btn.textContent = 'æ¸¬è©¦çœŸå¯¦æœå°‹';
            }
        }

        function updateProgress(percent) {
            document.getElementById('progress').style.width = percent + '%';
        }

        function updateSummary() {
            document.getElementById('totalTests').textContent = diagnosticResults.passed + diagnosticResults.failed + diagnosticResults.warnings;
            document.getElementById('passedTests').textContent = diagnosticResults.passed;
            document.getElementById('failedTests').textContent = diagnosticResults.failed;
            document.getElementById('warningTests').textContent = diagnosticResults.warnings;
        }

        function exportReport() {
            const report = {
                ...diagnosticResults,
                duration: diagnosticResults.endTime - diagnosticResults.startTime,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-report-${Date.now()}.json`;
            a.click();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // è‡ªå‹•è¼‰å…¥ config.js å’Œæª¢æŸ¥
        window.addEventListener('load', () => {
            console.log('é é¢å·²è¼‰å…¥ï¼Œæº–å‚™è¨ºæ–·');
        });
    </script>

    <!-- è¼‰å…¥å¿…è¦çš„æª”æ¡ˆ -->
    <script src="config.js"></script>
    <script src="app.js"></script>
</body>
</html>
